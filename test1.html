<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>数据视图</title>
  <script src="./node_modules/lodash/lodash.min.js"></script>
  <script src="./node_modules/jquery/dist/jquery.min.js"></script>
  <link rel="stylesheet" href="./lib/jquery-ui-1.12.1.custom/jquery-ui.min.css">
  <script src="./lib/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="main.css">
  <script src="./node_modules/vue/dist/vue.js"></script>

  <script src="node_modules/echarts/dist/echarts.min.js"></script>
  <script src="node_modules/split.js/split.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>


  <!-- <link rel="stylesheet" href="style.css"> -->
</head>

<body>
  <div class="wrap">
    <aside class="sidebar">
      
        <div id="left-chart-nav">
          <ul>
            <li class="active">
              <a class="left-chart-nav-link" id="left-chart-nav-line" href="#chart-type-line">
                <div class="chart-icon"></div>
                <div class="chart-name">Line</div>
              </a>
            </li>
            <li class="">
              <a class="left-chart-nav-link" id="left-chart-nav-bar" href="#chart-type-bar">
                <div class="chart-icon"></div>
                <div class="chart-name">Bar</div>
              </a>
            </li>
            <li class="">
              <a class="left-chart-nav-link" id="left-chart-nav-pie" href="#chart-type-pie">
                <div class="chart-icon"></div>
                <div class="chart-name">Pie</div>
              </a>
            </li>
          </ul>
      
      </div>
    </aside>
    <div class="parent main" id="app">
      <div id="one" class="split split-horizontal">
        <div id="a" class="split split-vertical draggable">
          <!-- <chart auto-resize :options='options[0]'></chart> -->
        </div>
        <div id="b" class="split split-vertical draggable">
          <!-- <chart :options='options[1]'></chart> -->
        </div>
        <div id="c" class="split split-vertical draggable">
          <!-- <chart :options='options[2]'></chart> -->
        </div>
      </div>
      <div id="two" class="split split-horizontal">
        <div id="d" class="split split-vertical draggable">
          <!-- <chart :options='options[3]'></chart> -->
        </div>
        <div id="e" class="split split-vertical draggable">
          <!-- <chart :options='options[4]'></chart> -->
        </div>
        <div id="f" class="split split-vertical draggable">
          <!-- <chart :options='options[5]'></chart> -->
        </div>
      </div>
      <div id="three" class="split split-horizontal">
        <!-- <p>#three</p> -->
        <div id="g" class="split split-vertical draggable">
          <!-- <chart :options='options[6]'></chart> -->
        </div>
        <div id="h" class="split split-vertical draggable">
          <!-- <chart :options='options[7]'></chart> -->
        </div>
        <div id="i" class="split split-vertical draggable">
          <!-- <chart :options='options[8]'></chart> -->
        </div>
      </div>
    </div>
  </div>

</body>

<script src="./lib/js/options.js"></script>
<script>
  let chartArr = []
  let charArr = genCharArray('a', 'z')

  //resize
  Split(['#one', '#two', '#three'], {
    sizes: [33.33, 33.33, 33.33],
    minSize: 200,
    onDragEnd
  });

  Split(['#a', '#b', '#c'], {
    direction: 'vertical',
    onDragEnd
  })
  Split(['#d', '#e', '#f'], {
    direction: 'vertical',
    onDragEnd
  })
  Split(['#g', '#h', '#i'], {
    direction: 'vertical',
    onDragEnd
  })

  

  //图标初始化
  chartArr = initChartArr(8)
  chartArr.forEach((chart, i) => {
    chart.setOption(options[i])
    $(chart._dom).data('index', i)
  })


  //拖拽逻辑
  $('.draggable').droppable({
    classes: {
      // "ui-droppable-active": "ui-state-active",
      "ui-droppable-hover": "ui-state-hover"
    },
    helper: true,
    drop: function (event, ui) {
      console.log('drop')
      let to = event.target
      let from = ui.draggable[0]
      from.innerHTML = ''
      to.innerHTML = ''
      let fromIndex = $(from).data('index')
      let toIndex = $(to).data('index')
      // debugger
      $(from).data('index', '')
      $(to).data('index', '')
      if($(from).is('.ui-draggable'))
        $(from).draggable('disable')
      if($(to).is('.ui-draggable'))
        $(to).draggable('disable')
      if(toIndex) {
        $(from).data('index', toIndex)
        createChart(from.id, options[toIndex])
      }
      if(fromIndex) {
        $(to).data('index', fromIndex)
        createChart(to.id, options[fromIndex])
      }
    }
  })

  
  //draggable
  function makeDrag(dom) {
    // if(!dom.chart)
    //   return
    $(dom).draggable({
      helper: function () {
        let oldCanvas = $(dom).find('canvas')[0]
        let oldCtx = oldCanvas.getContext('2d')
        let canvas = document.createElement('canvas')
        $(canvas).css('width', ($(oldCanvas).css('width')))
        $(canvas).css('height', ($(oldCanvas).css('height')))
        canvas.width = oldCanvas.width
        canvas.height = oldCanvas.height
        let ctx = canvas.getContext('2d')
        let data = oldCtx.getImageData(0, 0, oldCanvas.width, oldCanvas.height)
        ctx.putImageData(data, 0, 0)
        $(canvas).css('z-index', 1000)
        return ctx.canvas
      },
      cursor: "move",
      start() {
        console.log('start')
      }
    })
  }
  //loop through chart array to make dom draggable
  // chartArr.forEach((chart, i) => {
  //   makeDrag(chart._dom)
  // })

  function resize() {
    // debugger
    let resizeUndefined = chartArr.some(c => {
      return !c.resize
    })
    if (resizeUndefined) {
      console.log('resize undefined')
      return
    }
    chartArr.forEach(chart => {
      // debugger
      if (chart === null) {
        return
      }
      if (chart) {
        if (chart.resize) {
          chart.resize()
        }
      }
    })
  }

  window.onresize = resize



  function createChart(id, option) {
    let dom = document.getElementById(id)
    //如果dom元素之前未初始化拖拽，还要初始化
    if(!$(dom).is('.ui-draggable')) {
      makeDrag(dom)
    }
    else {
      $(dom).draggable('enable')
    }
    if (dom.chart) {
      let index = chartArr.indexOf(dom.chart)
      dom.chart.dispose()
      dom.chart = echarts.init(dom)
      chartArr.splice(index, 1, dom.chart)

    } else {
      dom.chart = echarts.init(dom)
    }
    if(option) {
      dom.chart.setOption(option)
    }
    return dom.chart
  }

  function genCharArray(charA, charZ) {
    var a = [],
      i = charA.charCodeAt(0),
      j = charZ.charCodeAt(0);
    for (; i <= j; ++i) {
      a.push(String.fromCharCode(i));
    }
    return a;
  }


  function initChartArr(length) {
    let arr = []
    for (let i = 0; i < length; i++) {
      arr.push(createChart(charArr[i]))
    }
    return arr
  }

  function onDragEnd() {
    console.log('drag end')
    // setTimeout(resize, 500)
    resize()
  }


  // new Vue({
  //   el: '#app',
  //   data: {
  //     options: options
  //   },
  //   mounted() {

  //   },
  //   methods: {

  //   }
  // })
</script>

</html>